<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex;
            height: 100vh;
        }
        #group-sidebar {
            width: 250px;
            background-color: #333;
            color: #fff;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        #group-sidebar h2 {
            margin-top: 0;
            font-size: 1.5em;
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
        }
        #group-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        #group-list li {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #444;
            transition: background-color 0.3s;
        }
        #group-list li.active {
            background-color: #555;
            font-weight: bold;
        }
        #group-list li:hover {
            background-color: #444;
        }
        #create-group-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px;
            border: none;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
            margin-top: 10px;
        }
        #main-chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: #fff;
            border-left: 1px solid #ddd;
        }
        #chat-header {
            background-color: #eee;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        #chat-box {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #ddd;
        }
        .message {
            background-color: #e9e9e9;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .message strong {
            color: #333;
        }
        .message-time {
            font-size: 0.8em;
            color: #777;
            margin-left: 10px;
        }
        .date-header {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-size: 0.9em;
            position: relative;
        }
        .date-header::before, .date-header::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }
        .date-header::before { left: 0; }
        .date-header::after { right: 0; }

        #input-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: #f4f4f4;
            border-top: 1px solid #ddd;
        }
        #input-row {
            display: flex;
            align-items: center;
            width: 100%;
        }
        #progress-status {
            text-align: center;
            color: #555;
            font-size: 0.9em;
            margin-bottom: 5px;
            visibility: hidden;
        }
        #username, #message {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }
        #username {
            width: 100px;
        }
        #message {
            flex-grow: 1;
        }
        #send-button, #add-image-button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #send-button:hover, #add-image-button:hover {
            background-color: #0056b3;
        }
        #add-image-button {
            background-color: #4CAF50;
            margin-left: 10px;
        }
        pre {
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .image-container {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="group-sidebar">
        <h2>聊天室列表</h2>
        <ul id="group-list">
        </ul>
        <button id="create-group-btn">新增群組</button>
    </div>

    <div id="main-chat-container">
        <div id="chat-header">
            <span id="current-group-title"></span>
        </div>
        <div id="chat-box">
            <!-- Messages will be loaded here -->
        </div>
        <div id="input-container">
            <div id="progress-status"></div>
            <div id="input-row">
                <input type="text" id="username" placeholder="你的名字" required>
                <input type="text" id="message" placeholder="輸入訊息..." required>
                <button id="add-image-button">新增圖片</button>
                <button id="send-button">送出</button>
            </div>
        </div>
    </div>
    
    <!-- 隱藏的檔案選擇輸入框 -->
    <input type="file" id="image-input" accept="image/*" style="display:none;">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 請將此處替換為您的 Apps Script 部署 URL
            const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw13ZKohUZlQU-jjrg8C-bN4au4Jd2KwjSa9jmHIVppYjOE-Avxew1Bz_gWWlUGus68/exec';

            const chatBox = document.getElementById('chat-box');
            const usernameInput = document.getElementById('username');
            const messageInput = document.getElementById('message');
            const sendButton = document.getElementById('send-button');
            const addImageButton = document.getElementById('add-image-button');
            const imageInput = document.getElementById('image-input');
            const groupList = document.getElementById('group-list');
            const createGroupBtn = document.getElementById('create-group-btn');
            const currentGroupTitle = document.getElementById('current-group-title');
            const progressStatus = document.getElementById('progress-status');

            let currentGroup = null;
            let lastDate = null;
            let fetchInterval = null;

            /** 將字串中的HTML特殊字元轉換為實體，避免XSS攻擊 */
            function escapeHtml(unsafe) {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            /** 格式化日期和時間 */
            function formatMessageTime(timestamp) {
                const date = new Date(timestamp);
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            /** 格式化日期標頭 */
            function formatDateHeader(timestamp) {
                const date = new Date(timestamp);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('zh-TW', options);
            }

            /** 獲取並顯示群組列表 */
            function fetchGroups() {
                $.ajax({
                    url: APPS_SCRIPT_URL,
                    type: 'GET',
                    data: { action: 'getGroups' },
                    dataType: 'jsonp',
                    success: function(response) {
                        groupList.innerHTML = '';
                        
                        let pinnedGroup = null;
                        const filteredGroups = response.groups.filter(group => {
                            if (group.GroupID === '0') {
                                pinnedGroup = group;
                                return false;
                            }
                            return true;
                        });
                        
                        if (pinnedGroup) {
                            currentGroup = pinnedGroup;
                            currentGroupTitle.textContent = pinnedGroup.GroupName;
                            messageInput.disabled = true;
                            messageInput.placeholder = "此為置頂公告區，無法發送訊息";
                            sendButton.disabled = true;
                            addImageButton.disabled = true;
                            selectGroup(pinnedGroup);
                        }

                        filteredGroups.forEach(group => {
                            const groupItem = document.createElement('li');
                            groupItem.textContent = group.GroupName;
                            groupItem.dataset.groupId = group.GroupID;
                            groupItem.addEventListener('click', () => selectGroup(group));
                            groupList.appendChild(groupItem);
                        });
                        
                        if (!currentGroup && filteredGroups.length > 0) {
                            selectGroup(filteredGroups[0]);
                        } else if (currentGroup && filteredGroups.length > 0) {
                            const activeGroupElement = document.querySelector(`[data-group-id="${currentGroup.GroupID}"]`);
                            if (activeGroupElement) {
                                activeGroupElement.classList.add('active');
                            }
                        } else if (!currentGroup) {
                            const noGroupsMessage = document.createElement('li');
                            noGroupsMessage.textContent = '沒有其他群組，請新增群組。';
                            noGroupsMessage.style.textAlign = 'center';
                            noGroupsMessage.style.padding = '15px';
                            groupList.appendChild(noGroupsMessage);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching groups:', error);
                    }
                });
            }

            /** 選擇群組並載入訊息 */
            function selectGroup(group) {
                if (currentGroup && currentGroup.GroupID === group.GroupID) {
                    return;
                }

                currentGroup = group;
                currentGroupTitle.textContent = group.GroupName;
                lastDate = null;
                messageInput.disabled = false;
                messageInput.placeholder = "輸入訊息...";
                sendButton.disabled = false;
                addImageButton.disabled = false;
                
                chatBox.innerHTML = '';
                
                document.querySelectorAll('#group-list li').forEach(item => item.classList.remove('active'));
                const activeGroupElement = document.querySelector(`[data-group-id="${group.GroupID}"]`);
                if (activeGroupElement) {
                    activeGroupElement.classList.add('active');
                }

                if (fetchInterval) {
                    clearInterval(fetchInterval);
                }

                fetchMessages(true);
                fetchInterval = setInterval(() => fetchMessages(false), 3000);
            }

            /** 讀取訊息 */
            function fetchMessages(isInitialLoad) {
                if (!currentGroup) return;

                const isScrolledToBottom = chatBox.scrollHeight - chatBox.clientHeight <= chatBox.scrollTop + 1;
                
                $.ajax({
                    url: APPS_SCRIPT_URL,
                    type: 'GET',
                    data: { 
                        groupID: currentGroup.GroupID,
                    },
                    dataType: 'jsonp',
                    success: function(response) {
                        if (!response.messages || response.messages.length === 0) {
                            return;
                        }

                        chatBox.innerHTML = '';
                        lastDate = null;
                        
                        response.messages.forEach(msg => {
                            if (!msg.message && !msg.temp_message) return;
                            
                            const messageDate = new Date(msg.Timestamp);
                            const currentDateString = messageDate.toDateString();

                            if (lastDate && currentDateString !== lastDate) {
                                const dateHeader = document.createElement('div');
                                dateHeader.classList.add('date-header');
                                dateHeader.textContent = formatDateHeader(messageDate);
                                chatBox.appendChild(dateHeader);
                            }
                            lastDate = currentDateString;

                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message');
                            
                            const messageContent = msg.message;
                            
                            // 根據類型顯示內容
                            if (msg.type === 'image') {
                                messageElement.innerHTML = `
                                    <strong>${escapeHtml(msg.user)}:</strong>
                                    <br><img src="${messageContent}" class="image-container" alt="user_image">
                                    <span class="message-time">${formatMessageTime(msg.Timestamp)}</span>
                                `;
                            } else {
                                const codeMatch = messageContent.match(/^`{3}([\s\S]*)`{3}$/);
                                if (codeMatch) {
                                    const codeContent = escapeHtml(codeMatch[1].trim());
                                    messageElement.innerHTML = `
                                        <strong>${escapeHtml(msg.user)}:</strong>
                                        <pre><code style="white-space: pre-wrap;">${codeContent}</code></pre>
                                        <span class="message-time">${formatMessageTime(msg.Timestamp)}</span>
                                    `;
                                } else {
                                    messageElement.innerHTML = `
                                        <strong>${escapeHtml(msg.user)}:</strong> ${escapeHtml(messageContent)}
                                        <span class="message-time">${formatMessageTime(msg.Timestamp)}</span>
                                    `;
                                }
                            }

                            chatBox.appendChild(messageElement);
                        });

                        if (isInitialLoad || isScrolledToBottom) {
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching messages:', error);
                    }
                });
            }

            /** 發送訊息函式（使用 GET 請求並切割訊息） */
            async function sendMessage(message, type = 'text', action='Get') {
                if (sendButton.disabled) return;
                if (!currentGroup) {
                    // 使用自訂模態對話框或在UI中顯示訊息，不要使用alert
                    console.log('請先選擇一個群組！'); 
                    return;
                }
                const user = usernameInput.value.trim();

                if (!user || !message) {
                     // 使用自訂模態對話框或在UI中顯示訊息，不要使用alert
                    console.log('請輸入你的名字和訊息！');
                    return;
                }
                
                var chunkSize = 1000;
		if (action == 'POST'){
		    chunkSize=400000;
		}
                const messageChunks = [];
                for (let i = 0; i < message.length; i += chunkSize) {
                    messageChunks.push(message.substring(i, i + chunkSize));
                }
                const totalChunks = messageChunks.length;

                // 只有當需要分塊時才顯示進度
                if (totalChunks > 1) {
                    progressStatus.style.visibility = 'visible';
                    usernameInput.disabled = true;
                    messageInput.disabled = true;
                    sendButton.disabled = true;
                    addImageButton.disabled = true;
                }

                let tempRowId = null;

                for (let i = 0; i < totalChunks; i++) {
                    const chunk = messageChunks[i];
                    progressStatus.textContent = `正在傳送... [${i + 1}/${totalChunks}]`;
                    let success = false;
                    for (let attempt = 0; attempt < 5; attempt++) {
                        try {
			    var ajaxData= {
                                    action: 'send',
                                    groupID: currentGroup.GroupID,
                                    user: user,
                                    messageChunk: chunk,
                                    chunkId: i,
                                    totalChunks: totalChunks,
                                    tempRowId: tempRowId,
                                    type: type
                            };
			    var ajaxParam={
                                url: APPS_SCRIPT_URL,
                                type: action,
                                data: ajaxData,
                                dataType: 'jsonp'
                            };
			    if(action=='POST'){
			       //ajaxData.redirect="follow";
			       ajaxParam.contentType="text/plain;charset=utf-8";
		               
			    }

                            const response = await $.ajax(ajaxParam);

                            if (response.status === 'success') {
                                if (response.tempRowId) {
                                    tempRowId = response.tempRowId;
                                }
                                success = true;
                                break; // 成功後跳出重試迴圈
                            } else {
                                throw new Error(response.message || '傳送失敗！');
                            }
                        } catch (error) {
                            console.error(`傳送分塊 ${i + 1} 失敗 (第 ${attempt + 1} 次重試):`, error);
                            // 延遲一段時間後再重試
                            await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt)));
                        }
                    }

                    if (!success) {
                        console.error(`分塊 ${i + 1} 重試 5 次後仍失敗，傳送中斷！`);
                        // 這裡可以選擇是否顯示錯誤訊息給用戶
                        break;
                    }
                }

                // 恢復輸入框和按鈕狀態
                progressStatus.style.visibility = 'hidden';
                usernameInput.disabled = false;
                messageInput.disabled = false;
                sendButton.disabled = false;
                addImageButton.disabled = false;
                messageInput.value = '';
                fetchMessages(true);
            }

            /** 建立新群組 */
            function createGroup() {
                const groupName = prompt('請輸入新群組名稱：');
                if (groupName) {
                    $.ajax({
                        url: APPS_SCRIPT_URL,
                        type: 'GET',
                        data: { action: 'createGroup', groupName: groupName },
                        dataType: 'jsonp',
                        success: function(response) {
                            if (response.status === 'success') {
                                // 使用自訂模態對話框或在UI中顯示訊息，不要使用alert
                                console.log('新群組已建立！');
                                fetchGroups();
                            } else {
                                // 使用自訂模態對話框或在UI中顯示訊息，不要使用alert
                                console.log('群組建立失敗！');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error creating group:', error);
                        }
                    });
                }
            }
            
            // 監聽圖片選擇
            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    sendMessage(base64String, 'image','GET');
                };
                reader.readAsDataURL(file);
            });

            sendButton.addEventListener('click', () => {
                sendMessage(messageInput.value);
            });
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage(messageInput.value);
                }
            });
            createGroupBtn.addEventListener('click', createGroup);
            addImageButton.addEventListener('click', () => {
                imageInput.click();
            });

            fetchGroups();
        });
    </script>
</body>
</html>
